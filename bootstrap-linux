#!/bin/bash
# Bootstrap an Ubuntu 12.04 machine.
#
# - Set hostname
# - Add domain name to DNS search path via /etc/network/interfaces
# - Update packages
# - Install Puppet agent.
# - Install prereqs for additional configuration

# Default values:
puppet_default_vers=3.2.4-1puppetlabs1

function usage {
    echo "Usage: $0 [-d puppet_version] -n fqdn [-s] [-p puppetmasterFQDN [-i puppetmasterIP]]"
    echo "Usage: $0 -h"
    echo
    echo "  -d   Override Puppet version (default: ${puppet_default_vers})"
    echo "  -n   Set FQDN"
    echo "  -s   Use static IP addressing (Rackspace)"
    echo "  -p   FQDN of Puppetmaster"
    echo "  -i   Puppetmaster IP address, if FQDN does not resolve"
    exit 1
}

dhcp=on

while getopts "d:hi:n:p:s" flag
do
    case $flag in
	d) puppet_version=$OPTARG ;;
	i) pmip=$OPTARG ;;
	n) fqdn=$OPTARG ;;
	p) puppetmaster=$OPTARG ;;
        s) dhcp=off ;;
	*) usage ;;
    esac
done

# Check for non-default Puppet version to install:
puppet_version=${puppet_version:-$puppet_default_vers}

# Fqdn is a required argument:
if [ -z "$fqdn" ] ; then
    echo "Please set a fully-qualified domain name."
    echo
    usage
fi

if [ -z "$puppetmaster" ] ; then
    if [ ! -z "$pmip" ] ; then
	echo "Must set Puppetmaster FQDN when specifying its IP"
	echo
	usage
    fi
fi

# Set hostname, by removing domain from fqdn:
hostname=$(echo "${fqdn}" | sed 's/\..*$//')
echo $hostname > /etc/hostname
/bin/hostname -F /etc/hostname

if [ $dhcp == 'on' ]; then
    domain=`echo ${fqdn} | sed 's/^[^.]*\.//'`
    cat > /etc/network/interfaces <<EOF
auto lo eth0
iface lo inet loopback

iface eth0 inet dhcp
  dns-domain $domain
EOF
    /usr/sbin/service networking restart
fi

# Add puppet repo:
/usr/bin/curl -L -o /tmp/puppetlabs-release-precise.deb http://apt.puppetlabs.com/puppetlabs-release-precise.deb
/usr/bin/dpkg -i /tmp/puppetlabs-release-precise.deb

# Update installed packages:
/usr/bin/apt-get update
/usr/bin/apt-get -y dist-upgrade

# Add puppet agent:
/usr/bin/apt-get -y install puppet=${puppet_version} puppet-common=${puppet_version}

# Add additional packages:
/usr/bin/apt-get -y install git

# Add IP address and hostname to /etc/hosts:
hosts_tmp=$(mktemp)
chmod 644 $hosts_tmp
ip=$(facter ipaddress)
echo "127.0.1.1 ${fqdn} ${hostname}" > $hosts_tmp
grep -v 127.0.1.1 /etc/hosts >> $hosts_tmp
mv $hosts_tmp /etc/hosts

if [ ! -z "$puppetmaster" ] ; then
    cat > /etc/puppet/puppet.conf <<EOF
[main]
logdir=/var/log/puppet
vardir=/var/lib/puppet
ssldir=/var/lib/puppet/ssl
rundir=/var/run/puppet
factpath=\$vardir/lib/facter
templatedir=\$confdir/templates
server = $puppetmaster

[master]
# These are needed when the puppetmaster is run by passenger
# and can safely be removed if webrick is used.
ssl_client_header = SSL_CLIENT_S_DN 
ssl_client_verify_header = SSL_CLIENT_VERIFY

EOF

    if [ ! -z "$pmip" ] ; then
	pmhostname=$(echo "${puppetmaster}" | sed 's/\..*$//')
	echo "$pmip $puppetmaster $pmhostname" >> /etc/hosts
    fi

fi

echo "Bootstrap complete."
